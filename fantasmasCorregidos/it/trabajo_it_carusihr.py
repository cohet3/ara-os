# -*- coding: utf-8 -*-
import re, sys, HTMLParser, urllib2, ssl, json, requests
from urlparse import parse_qs
from urllib import urlencode
from StringIO import StringIO
import gzip
from base_it import db_it, slavy, text, dalek
#from stem.control import Controller
ssl._create_default_https_context = ssl._create_unverified_context

fetched_from = 'jobs.carusihr.com'

xtr = '''title
data-title="Titolo">
</span>
description
data-title="Testo">
</table>
city
<div id="VM13_FindView_SCViewPrint_FormStampa1_Fld143921066" class="DISABLEDFIELD" Rows="4" >
</div>'''

xtr_view = '''viewstate
id="__VIEWSTATE" value="
"
generator
id="__VIEWSTATEGENERATOR" value="
"
validation
id="__EVENTVALIDATION" value="
"'''

stp = '/annunci-lavoro/'
page_ads = 10
page_stp = 1

pagination_generator = lambda url: (url.format(page=page) for page in xrange(1, 8))
# with Controller.from_port(port = 9051) as controller:
# pass
pages = (
    ('Trabajo', {
        'trabajo_subcat': (
            'http://jobs.carusihr.com/!__VIEWSTATE=%2FwEPDwUBMA9kFgICAg9kFgICAQ9kFgICFQ9kFgICAQ9kFgICAw9kFgJmD2QWAgIBD2QWBAIBD2QWAmYPZBYCAgEPZBYEAgEPZBYCAgUPZBYCAgEPFgIeB1Zpc2libGVoZAIDD2QWAgIDD2QWAmYPZBYCZg8WAh4CaWQFDlBvcnRsZXRCdXR0b241ZAIDD2QWAgIBD2QWBGYPZBYEAgEPZBYCZg8WAh4ZVk1Gb3JtUmljZXJjYTc6UGFyYW1ldGVyczKuDwABAAAA%2F%2F%2F%2F%2FwEAAAAAAAAADAIAAABQQWx0YW1pcmEuV2ViLlVJLCBWZXJzaW9uPTIwMTcuMy42NzE4LjI1MTY5LCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPW51bGwFAQAAACBBbHRhbWlyYS5XZWIuRGF0YS5EYXRhQ29sbGVjdGlvbgIAAAAKbV9PcGVyYXRvchNDb2xsZWN0aW9uQmFzZStsaXN0BAMcQWx0YW1pcmEuV2ViLlVJLlR5cGVPcGVyYXRvcgIAAAAcU3lzdGVtLkNvbGxlY3Rpb25zLkFycmF5TGlzdAIAAAAF%2Ff%2F%2F%2FxxBbHRhbWlyYS5XZWIuVUkuVHlwZU9wZXJhdG9yAQAAAAd2YWx1ZV9fAAgCAAAAAAAAAAkEAAAABAQAAAAcU3lzdGVtLkNvbGxlY3Rpb25zLkFycmF5TGlzdAMAAAAGX2l0ZW1zBV9zaXplCF92ZXJzaW9uBQAACAgJBQAAAAYAAAAHAAAAEAUAAAAIAAAACQYAAAAJBwAAAAkIAAAACQkAAAAJCgAAAAkLAAAADQIFBgAAABxBbHRhbWlyYS5XZWIuRGF0YS5EYXRhT2JqZWN0CgAAAAdtX1RhYmxlC21fRmllbGROYW1lDW1fQ29udHJvbE5hbWUHbV9WYWx1ZQ9tX1ZhbHVlRXh0ZW5kZWQMbV9Db21wYXJpc29uBm1fVHlwZRBtX011bHRpcGxlVmFsdWVzC21fRGF0YUJvdW5kEG1fU3Vic3RpdHV0ZVBpcGUBAQECAgQEAAABK0FsdGFtaXJhLldlYi5EYXRhLkRhdGFPYmplY3QrQ29tcGFyaXNvbkVudW0CAAAAGEFsdGFtaXJhLldlYi5VSS5UeXBlRW51bQIAAAABAQIAAAAKBgwAAAACSUQJDAAAAAYNAAAAC0Zvcm1SaWNlcmNhCgXy%2F%2F%2F%2FK0FsdGFtaXJhLldlYi5EYXRhLkRhdGFPYmplY3QrQ29tcGFyaXNvbkVudW0BAAAAB3ZhbHVlX18ACAIAAAABAAAABfH%2F%2F%2F8YQWx0YW1pcmEuV2ViLlVJLlR5cGVFbnVtAQAAAAd2YWx1ZV9fAAgCAAAAAAAAAAABBhAAAAAHJSMxMjQjJQEHAAAABgAAAAoGEQAAABNTdWJtaXRPbkVudGVyQnV0dG9uCREAAAAGEgAAAAdjbWRGaW5kCgHt%2F%2F%2F%2F8v%2F%2F%2FwEAAAAB7P%2F%2F%2F%2FH%2F%2F%2F8AAAAAAAEJEAAAAAEIAAAABgAAAAoGFgAAAAhDc3NDbGFzcwkWAAAABhcAAAAACgHo%2F%2F%2F%2F8v%2F%2F%2FwEAAAAB5%2F%2F%2F%2F%2FH%2F%2F%2F8AAAAAAAEJEAAAAAEJAAAABgAAAAoGGwAAAARuYW1lCRsAAAAGHAAAABxGcm9udG9mZmljZTogUmljZXJjYSBBbm51bmNpCgHj%2F%2F%2F%2F8v%2F%2F%2FwEAAAAB4v%2F%2F%2F%2FH%2F%2F%2F8AAAAAAAEJEAAAAAEKAAAABgAAAAoGIAAAAAlIdG1sSW5wdXQJIAAAAAYhAAAAzQUNCiAgICAgICAgPGRpdiBjbGFzcz0icm93Ij4NCiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC14cy0xMiBjb2wtc20tNiBjb2wtbW0tNiBjb2wtbGctNCI%2BDQogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYm94Ij5QYXJvbGUgY2hpYXZlIDwvZGl2Pg0KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImJveCI%2BPGNtczpmaWVsZCBUYWdOYW1lPSJKb2JzLkZyZWVTZWFyY2giIC8%2BPC9kaXY%2BDQogICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC14cy0xMiBjb2wtc20tNiBjb2wtbW0tNiBjb2wtbGctNCI%2BDQogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYm94Ij5TZWRpIDwvZGl2Pg0KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImJveCI%2BPGNtczpmaWVsZCBUYWdOYW1lPSJMb2NhdGlvbnMuUHJlZmVycmVkTG9jYXRpb25zIiAvPiA8L2Rpdj4NCiAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLXhzLTEyIGNvbC1zbS02IGNvbC1tbS02IGNvbC1sZy00Ij4NCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJib3giPkJ1c2luZXNzIHVuaXQ8L2Rpdj4NCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJib3giPjxjbXM6ZmllbGQgVGFnTmFtZT0iVmFjYW5jeS5CdXNpbmVzc1VuaXRzIiAvPjwvZGl2PiANCiAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICA8L2Rpdj4NCiAgICAKAd7%2F%2F%2F%2Fy%2F%2F%2F%2FAQAAAAHd%2F%2F%2F%2F8f%2F%2F%2FwAAAAAAAQkQAAAAAQsAAAAGAAAACgYlAAAAElJlc291cmNlRG9jdW1lbnRJRAklAAAACAgLFJQICgHa%2F%2F%2F%2F8v%2F%2F%2FwEAAAAB2f%2F%2F%2F%2FH%2F%2F%2F8AAAAAAAEJEAAAAAsWAmYPFgIeIlZNRm9ybVJpY2VyY2E3JEZpbmRWaWV3OlBhcmFtZXRlcnMyrg8AAQAAAP%2F%2F%2F%2F8BAAAAAAAAAAwCAAAAUEFsdGFtaXJhLldlYi5VSSwgVmVyc2lvbj0yMDE3LjMuNjcxOC4yNTE2OSwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1udWxsBQEAAAAgQWx0YW1pcmEuV2ViLkRhdGEuRGF0YUNvbGxlY3Rpb24CAAAACm1fT3BlcmF0b3ITQ29sbGVjdGlvbkJhc2UrbGlzdAQDHEFsdGFtaXJhLldlYi5VSS5UeXBlT3BlcmF0b3ICAAAAHFN5c3RlbS5Db2xsZWN0aW9ucy5BcnJheUxpc3QCAAAABf3%2F%2F%2F8cQWx0YW1pcmEuV2ViLlVJLlR5cGVPcGVyYXRvcgEAAAAHdmFsdWVfXwAIAgAAAAAAAAAJBAAAAAQEAAAAHFN5c3RlbS5Db2xsZWN0aW9ucy5BcnJheUxpc3QDAAAABl9pdGVtcwVfc2l6ZQhfdmVyc2lvbgUAAAgICQUAAAAGAAAABwAAABAFAAAACAAAAAkGAAAACQcAAAAJCAAAAAkJAAAACQoAAAAJCwAAAA0CBQYAAAAcQWx0YW1pcmEuV2ViLkRhdGEuRGF0YU9iamVjdAoAAAAHbV9UYWJsZQttX0ZpZWxkTmFtZQ1tX0NvbnRyb2xOYW1lB21fVmFsdWUPbV9WYWx1ZUV4dGVuZGVkDG1fQ29tcGFyaXNvbgZtX1R5cGUQbV9NdWx0aXBsZVZhbHVlcwttX0RhdGFCb3VuZBBtX1N1YnN0aXR1dGVQaXBlAQEBAgIEBAAAAStBbHRhbWlyYS5XZWIuRGF0YS5EYXRhT2JqZWN0K0NvbXBhcmlzb25FbnVtAgAAABhBbHRhbWlyYS5XZWIuVUkuVHlwZUVudW0CAAAAAQECAAAACgYMAAAAAklECQwAAAAGDQAAAAtGb3JtUmljZXJjYQoF8v%2F%2F%2FytBbHRhbWlyYS5XZWIuRGF0YS5EYXRhT2JqZWN0K0NvbXBhcmlzb25FbnVtAQAAAAd2YWx1ZV9fAAgCAAAAAQAAAAXx%2F%2F%2F%2FGEFsdGFtaXJhLldlYi5VSS5UeXBlRW51bQEAAAAHdmFsdWVfXwAIAgAAAAAAAAAAAQYQAAAAByUjMTI0IyUBBwAAAAYAAAAKBhEAAAATU3VibWl0T25FbnRlckJ1dHRvbgkRAAAABhIAAAAHY21kRmluZAoB7f%2F%2F%2F%2FL%2F%2F%2F8BAAAAAez%2F%2F%2F%2Fx%2F%2F%2F%2FAAAAAAABCRAAAAABCAAAAAYAAAAKBhYAAAAIQ3NzQ2xhc3MJFgAAAAYXAAAAAAoB6P%2F%2F%2F%2FL%2F%2F%2F8BAAAAAef%2F%2F%2F%2Fx%2F%2F%2F%2FAAAAAAABCRAAAAABCQAAAAYAAAAKBhsAAAAEbmFtZQkbAAAABhwAAAAcRnJvbnRvZmZpY2U6IFJpY2VyY2EgQW5udW5jaQoB4%2F%2F%2F%2F%2FL%2F%2F%2F8BAAAAAeL%2F%2F%2F%2Fx%2F%2F%2F%2FAAAAAAABCRAAAAABCgAAAAYAAAAKBiAAAAAJSHRtbElucHV0CSAAAAAGIQAAAM0FDQogICAgICAgIDxkaXYgY2xhc3M9InJvdyI%2BDQogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wteHMtMTIgY29sLXNtLTYgY29sLW1tLTYgY29sLWxnLTQiPg0KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImJveCI%2BUGFyb2xlIGNoaWF2ZSA8L2Rpdj4NCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJib3giPjxjbXM6ZmllbGQgVGFnTmFtZT0iSm9icy5GcmVlU2VhcmNoIiAvPjwvZGl2Pg0KICAgICAgICAgICAgPC9kaXY%2BDQogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2wteHMtMTIgY29sLXNtLTYgY29sLW1tLTYgY29sLWxnLTQiPg0KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImJveCI%2BU2VkaSA8L2Rpdj4NCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJib3giPjxjbXM6ZmllbGQgVGFnTmFtZT0iTG9jYXRpb25zLlByZWZlcnJlZExvY2F0aW9ucyIgLz4gPC9kaXY%2BDQogICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC14cy0xMiBjb2wtc20tNiBjb2wtbW0tNiBjb2wtbGctNCI%2BDQogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYm94Ij5CdXNpbmVzcyB1bml0PC9kaXY%2BDQogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYm94Ij48Y21zOmZpZWxkIFRhZ05hbWU9IlZhY2FuY3kuQnVzaW5lc3NVbml0cyIgLz48L2Rpdj4gDQogICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgPC9kaXY%2BDQogICAgCgHe%2F%2F%2F%2F8v%2F%2F%2FwEAAAAB3f%2F%2F%2F%2FH%2F%2F%2F8AAAAAAAEJEAAAAAELAAAABgAAAAoGJQAAABJSZXNvdXJjZURvY3VtZW50SUQJJQAAAAgICxSUCAoB2v%2F%2F%2F%2FL%2F%2F%2F8BAAAAAdn%2F%2F%2F%2Fx%2F%2F%2F%2FAAAAAAABCRAAAAALFgJmDw8WAh4uVk1Gb3JtUmljZXJjYTckRmluZFZpZXckRm9ybVJpY2VyY2E6UGFyYW1ldGVyczKuDwABAAAA%2F%2F%2F%2F%2FwEAAAAAAAAADAIAAABQQWx0YW1pcmEuV2ViLlVJLCBWZXJzaW9uPTIwMTcuMy42NzE4LjI1MTY5LCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPW51bGwFAQAAACBBbHRhbWlyYS5XZWIuRGF0YS5EYXRhQ29sbGVjdGlvbgIAAAAKbV9PcGVyYXRvchNDb2xsZWN0aW9uQmFzZStsaXN0BAMcQWx0YW1pcmEuV2ViLlVJLlR5cGVPcGVyYXRvcgIAAAAcU3lzdGVtLkNvbGxlY3Rpb25zLkFycmF5TGlzdAIAAAAF%2Ff%2F%2F%2FxxBbHRhbWlyYS5XZWIuVUkuVHlwZU9wZXJhdG9yAQAAAAd2YWx1ZV9fAAgCAAAAAAAAAAkEAAAABAQAAAAcU3lzdGVtLkNvbGxlY3Rpb25zLkFycmF5TGlzdAMAAAAGX2l0ZW1zBV9zaXplCF92ZXJzaW9uBQAACAgJBQAAAAYAAAAHAAAAEAUAAAAIAAAACQYAAAAJBwAAAAkIAAAACQkAAAAJCgAAAAkLAAAADQIFBgAAABxBbHRhbWlyYS5XZWIuRGF0YS5EYXRhT2JqZWN0CgAAAAdtX1RhYmxlC21fRmllbGROYW1lDW1fQ29udHJvbE5hbWUHbV9WYWx1ZQ9tX1ZhbHVlRXh0ZW5kZWQMbV9Db21wYXJpc29uBm1fVHlwZRBtX011bHRpcGxlVmFsdWVzC21fRGF0YUJvdW5kEG1fU3Vic3RpdHV0ZVBpcGUBAQECAgQEAAABK0FsdGFtaXJhLldlYi5EYXRhLkRhdGFPYmplY3QrQ29tcGFyaXNvbkVudW0CAAAAGEFsdGFtaXJhLldlYi5VSS5UeXBlRW51bQIAAAABAQIAAAAKBgwAAAACSUQJDAAAAAYNAAAAC0Zvcm1SaWNlcmNhCgXy%2F%2F%2F%2FK0FsdGFtaXJhLldlYi5EYXRhLkRhdGFPYmplY3QrQ29tcGFyaXNvbkVudW0BAAAAB3ZhbHVlX18ACAIAAAABAAAABfH%2F%2F%2F8YQWx0YW1pcmEuV2ViLlVJLlR5cGVFbnVtAQAAAAd2YWx1ZV9fAAgCAAAAAAAAAAABBhAAAAAHJSMxMjQjJQEHAAAABgAAAAoGEQAAABNTdWJtaXRPbkVudGVyQnV0dG9uCREAAAAGEgAAAAdjbWRGaW5kCgHt%2F%2F%2F%2F8v%2F%2F%2FwEAAAAB7P%2F%2F%2F%2FH%2F%2F%2F8AAAAAAAEJEAAAAAEIAAAABgAAAAoGFgAAAAhDc3NDbGFzcwkWAAAABhcAAAAACgHo%2F%2F%2F%2F8v%2F%2F%2FwEAAAAB5%2F%2F%2F%2F%2FH%2F%2F%2F8AAAAAAAEJEAAAAAEJAAAABgAAAAoGGwAAAARuYW1lCRsAAAAGHAAAABxGcm9udG9mZmljZTogUmljZXJjYSBBbm51bmNpCgHj%2F%2F%2F%2F8v%2F%2F%2FwEAAAAB4v%2F%2F%2F%2FH%2F%2F%2F8AAAAAAAEJEAAAAAEKAAAABgAAAAoGIAAAAAlIdG1sSW5wdXQJIAAAAAYhAAAAzQUNCiAgICAgICAgPGRpdiBjbGFzcz0icm93Ij4NCiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC14cy0xMiBjb2wtc20tNiBjb2wtbW0tNiBjb2wtbGctNCI%2BDQogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYm94Ij5QYXJvbGUgY2hpYXZlIDwvZGl2Pg0KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImJveCI%2BPGNtczpmaWVsZCBUYWdOYW1lPSJKb2JzLkZyZWVTZWFyY2giIC8%2BPC9kaXY%2BDQogICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbC14cy0xMiBjb2wtc20tNiBjb2wtbW0tNiBjb2wtbGctNCI%2BDQogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYm94Ij5TZWRpIDwvZGl2Pg0KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImJveCI%2BPGNtczpmaWVsZCBUYWdOYW1lPSJMb2NhdGlvbnMuUHJlZmVycmVkTG9jYXRpb25zIiAvPiA8L2Rpdj4NCiAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY29sLXhzLTEyIGNvbC1zbS02IGNvbC1tbS02IGNvbC1sZy00Ij4NCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJib3giPkJ1c2luZXNzIHVuaXQ8L2Rpdj4NCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJib3giPjxjbXM6ZmllbGQgVGFnTmFtZT0iVmFjYW5jeS5CdXNpbmVzc1VuaXRzIiAvPjwvZGl2PiANCiAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICA8L2Rpdj4NCiAgICAKAd7%2F%2F%2F%2Fy%2F%2F%2F%2FAQAAAAHd%2F%2F%2F%2F8f%2F%2F%2FwAAAAAAAQkQAAAAAQsAAAAGAAAACgYlAAAAElJlc291cmNlRG9jdW1lbnRJRAklAAAACAgLFJQICgHa%2F%2F%2F%2F8v%2F%2F%2FwEAAAAB2f%2F%2F%2F%2FH%2F%2F%2F8AAAAAAAEJEAAAAAtkFgJmD2QWAgIDD2QWAgICD2QWBgIBD2QWAgIDD2QWBGYPDxYCHgRUZXh0ZWRkAgEPDxYKHgxFcnJvck1lc3NhZ2UFZklsIGNhbXBvICJSaWNlcmNhIGxpYmVyYSIgZGV2ZSBlc3NlcmUgZGkgdGlwbyAiVGVzdG8iIChmb3JtYXQ6ICIlJXR5cGVfdGV4dCUlIiBmb3IgIiUlZXhhbXBsZV90ZXh0JSUiKR4HRGlzcGxheQsqKlN5c3RlbS5XZWIuVUkuV2ViQ29udHJvbHMuVmFsaWRhdG9yRGlzcGxheQIeDFJlcXVpcmVkVHlwZQspekFsdGFtaXJhLldlYi5WYWxpZGF0aW9uLlJlcXVpcmVkVHlwZUVudW0sIEFsdGFtaXJhLldlYi5VSSwgVmVyc2lvbj0yMDE3LjMuNjcxOC4yNTE2OSwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1udWxsAB4RQ29udHJvbFRvVmFsaWRhdGUFDEZsZDE1NDAwMjY1NB4MQ29udHJvbExhYmVsBQ5SaWNlcmNhIGxpYmVyYWRkAgMPZBYCAgMPZBYCAgEPFgIeBVZhbHVlZWQCBQ9kFgICAw9kFgICAQ8WAh8LZWQCAw9kFgICAQ9kFgJmDxYCHgVjbGFzcwUGYnV0dG9uZAICD2QWBAIDD2QWAmYPFgIeD1ZNMTA6UGFyYW1ldGVyczKcEQABAAAA%2F%2F%2F%2F%2FwEAAAAAAAAADAIAAABQQWx0YW1pcmEuV2ViLlVJLCBWZXJzaW9uPTIwMTcuMy42NzE4LjI1MTY5LCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPW51bGwFAQAAACBBbHRhbWlyYS5XZWIuRGF0YS5EYXRhQ29sbGVjdGlvbgIAAAAKbV9PcGVyYXRvchNDb2xsZWN0aW9uQmFzZStsaXN0BAMcQWx0YW1pcmEuV2ViLlVJLlR5cGVPcGVyYXRvcgIAAAAcU3lzdGVtLkNvbGxlY3Rpb25zLkFycmF5TGlzdAIAAAAF%2Ff%2F%2F%2FxxBbHRhbWlyYS5XZWIuVUkuVHlwZU9wZXJhdG9yAQAAAAd2YWx1ZV9fAAgCAAAAAAAAAAkEAAAABAQAAAAcU3lzdGVtLkNvbGxlY3Rpb25zLkFycmF5TGlzdAMAAAAGX2l0ZW1zBV9zaXplCF92ZXJzaW9uBQAACAgJBQAAAAoAAAALAAAAEAUAAAAQAAAACQYAAAAJBwAAAAkIAAAACQkAAAAJCgAAAAkLAAAACQwAAAAJDQAAAAkOAAAACQ8AAAANBgUGAAAAHEFsdGFtaXJhLldlYi5EYXRhLkRhdGFPYmplY3QKAAAAB21fVGFibGULbV9GaWVsZE5hbWUNbV9Db250cm9sTmFtZQdtX1ZhbHVlD21fVmFsdWVFeHRlbmRlZAxtX0NvbXBhcmlzb24GbV9UeXBlEG1fTXVsdGlwbGVWYWx1ZXMLbV9EYXRhQm91bmQQbV9TdWJzdGl0dXRlUGlwZQEBAQICBAQAAAErQWx0YW1pcmEuV2ViLkRhdGEuRGF0YU9iamVjdCtDb21wYXJpc29uRW51bQIAAAAYQWx0YW1pcmEuV2ViLlVJLlR5cGVFbnVtAgAAAAEBAgAAAAoGEAAAAAdUYWdOYW1lCRAAAAAGEQAAABpGcm9udG9mZmljZTogTGlzdGEgYW5udW5jaQoF7v%2F%2F%2FytBbHRhbWlyYS5XZWIuRGF0YS5EYXRhT2JqZWN0K0NvbXBhcmlzb25FbnVtAQAAAAd2YWx1ZV9fAAgCAAAAAQAAAAXt%2F%2F%2F%2FGEFsdGFtaXJhLldlYi5VSS5UeXBlRW51bQEAAAAHdmFsdWVfXwAIAgAAAAAAAAAAAQYUAAAAByUjMTI0IyUBBwAAAAYAAAAKBhUAAAAOT3JkZXJCeUNvbHVtbnMJFQAAAAYWAAAAF0pvYnMuRGF0ZVB1Ymxpc2hlZCBERVNDCgHp%2F%2F%2F%2F7v%2F%2F%2FwEAAAAB6P%2F%2F%2F%2B3%2F%2F%2F8AAAAAAAEJFAAAAAEIAAAABgAAAAoGGgAAAA9DbGljY2FibGVDb2x1bW4JGgAAAAYbAAAACkpvYnMuVGl0bGUKAeT%2F%2F%2F%2Fu%2F%2F%2F%2FAQAAAAHj%2F%2F%2F%2F7f%2F%2F%2FwAAAAAAAQkUAAAAAQkAAAAGAAAACgYfAAAAA3VybAkfAAAABiAAAAAKJSVKT0JVUkwlJQoB3%2F%2F%2F%2F%2B7%2F%2F%2F8BAAAAAd7%2F%2F%2F%2Ft%2F%2F%2F%2FAAAAAAABCRQAAAABCgAAAAYAAAAKBiQAAAAQTm9SZWNvcmRzTWVzc2FnZQkkAAAABiUAAAAXTmVzc3VuIGFubnVuY2lvIHRyb3ZhdG8KAdr%2F%2F%2F%2Fu%2F%2F%2F%2FAQAAAAHZ%2F%2F%2F%2F7f%2F%2F%2FwAAAAAAAQkUAAAAAQsAAAAGAAAACgYpAAAADUhpZGRlbkNvbHVtbnMJKQAAAAYqAAAACkpvYnMuSm9iSUQKAdX%2F%2F%2F%2Fu%2F%2F%2F%2FAQAAAAHU%2F%2F%2F%2F7f%2F%2F%2FwAAAAAAAQkUAAAAAQwAAAAGAAAACgYuAAAAC1Jvd3NQZXJQYWdlCS4AAAAGLwAAAAIxMAoB0P%2F%2F%2F%2B7%2F%2F%2F8BAAAAAc%2F%2F%2F%2F%2Ft%2F%2F%2F%2FAAAAAAABCRQAAAABDQAAAAYAAAAKBjMAAAAaVXBkYXRlSW1wcmVzc2lvblN0YXRpc3RpY3MJMwAAAAY0AAAABHRydWUKAcv%2F%2F%2F%2Fu%2F%2F%2F%2FAQAAAAHK%2F%2F%2F%2F7f%2F%2F%2FwAAAAAAAQkUAAAAAQ4AAAAGAAAACgY4AAAACUh0bWxJbnB1dAk4AAAABjkAAACtBA0KICAgICAgICA8Z3JpZD4NCiAgICAgICAgICAgIDxjb2x1bW5zPg0KICAgICAgICAgICAgICAgIDxjb2x1bW4gVGFnTmFtZT0iSm9icy5Kb2JJRCIgSGlkZGVuQ29sdW1uPSJ0cnVlIiAvPg0KICAgICAgICAgICAgICAgIDxjb2x1bW4gVGFnTmFtZT0iSm9icy5UaXRsZSIgQ3NzQ2xhc3NDZWxsPSJHUklEX0RBVF9DRUwgdGl0bGVDZWxsIiBVUkw9IiUlSk9CVVJMJSUiIC8%2BDQogICAgICAgICAgICAgICAgPGNvbHVtbiBUYWdOYW1lPSJKb2JzLkRhdGVQdWJsaXNoZWQiIENzc0NsYXNzQ2VsbD0iR1JJRF9EQVRfQ0VMIGF1dG9XaWR0aCIgLz4NCiAgICAgICAgICAgICAgICA8Y29sdW1uIFRhZ05hbWU9IkxvY2F0aW9ucy5QcmVmZXJyZWRMb2NhdGlvbnMiIENzc0NsYXNzQ2VsbD0iR1JJRF9EQVRfQ0VMIGF1dG9XaWR0aCIgLz4NCiAgICAgICAgICAgICAgICA8Y29sdW1uIFRhZ05hbWU9IlZhY2FuY3kuQnVzaW5lc3NVbml0cyIgQ3NzQ2xhc3NDZWxsPSJHUklEX0RBVF9DRUwgYXV0b1dpZHRoIiAvPg0KICAgICAgICAgICAgPC9jb2x1bW5zPg0KICAgICAgICA8L2dyaWQ%2BDQogICAgCgHG%2F%2F%2F%2F7v%2F%2F%2FwEAAAABxf%2F%2F%2F%2B3%2F%2F%2F8AAAAAAAEJFAAAAAEPAAAABgAAAAoGPQAAABJSZXNvdXJjZURvY3VtZW50SUQJPQAAAAgICxSUCAoBwv%2F%2F%2F%2B7%2F%2F%2F8BAAAAAcH%2F%2F%2F%2Ft%2F%2F%2F%2FAAAAAAABCRQAAAALFgJmDxYCHhlWTTEwJFRhYmxlVmlldzpQYXJhbWV0ZXJzMpwRAAEAAAD%2F%2F%2F%2F%2FAQAAAAAAAAAMAgAAAFBBbHRhbWlyYS5XZWIuVUksIFZlcnNpb249MjAxNy4zLjY3MTguMjUxNjksIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAIEFsdGFtaXJhLldlYi5EYXRhLkRhdGFDb2xsZWN0aW9uAgAAAAptX09wZXJhdG9yE0NvbGxlY3Rpb25CYXNlK2xpc3QEAxxBbHRhbWlyYS5XZWIuVUkuVHlwZU9wZXJhdG9yAgAAABxTeXN0ZW0uQ29sbGVjdGlvbnMuQXJyYXlMaXN0AgAAAAX9%2F%2F%2F%2FHEFsdGFtaXJhLldlYi5VSS5UeXBlT3BlcmF0b3IBAAAAB3ZhbHVlX18ACAIAAAAAAAAACQQAAAAEBAAAABxTeXN0ZW0uQ29sbGVjdGlvbnMuQXJyYXlMaXN0AwAAAAZfaXRlbXMFX3NpemUIX3ZlcnNpb24FAAAICAkFAAAACgAAAAsAAAAQBQAAABAAAAAJBgAAAAkHAAAACQgAAAAJCQAAAAkKAAAACQsAAAAJDAAAAAkNAAAACQ4AAAAJDwAAAA0GBQYAAAAcQWx0YW1pcmEuV2ViLkRhdGEuRGF0YU9iamVjdAoAAAAHbV9UYWJsZQttX0ZpZWxkTmFtZQ1tX0NvbnRyb2xOYW1lB21fVmFsdWUPbV9WYWx1ZUV4dGVuZGVkDG1fQ29tcGFyaXNvbgZtX1R5cGUQbV9NdWx0aXBsZVZhbHVlcwttX0RhdGFCb3VuZBBtX1N1YnN0aXR1dGVQaXBlAQEBAgIEBAAAAStBbHRhbWlyYS5XZWIuRGF0YS5EYXRhT2JqZWN0K0NvbXBhcmlzb25FbnVtAgAAABhBbHRhbWlyYS5XZWIuVUkuVHlwZUVudW0CAAAAAQECAAAACgYQAAAAB1RhZ05hbWUJEAAAAAYRAAAAGkZyb250b2ZmaWNlOiBMaXN0YSBhbm51bmNpCgXu%2F%2F%2F%2FK0FsdGFtaXJhLldlYi5EYXRhLkRhdGFPYmplY3QrQ29tcGFyaXNvbkVudW0BAAAAB3ZhbHVlX18ACAIAAAABAAAABe3%2F%2F%2F8YQWx0YW1pcmEuV2ViLlVJLlR5cGVFbnVtAQAAAAd2YWx1ZV9fAAgCAAAAAAAAAAABBhQAAAAHJSMxMjQjJQEHAAAABgAAAAoGFQAAAA5PcmRlckJ5Q29sdW1ucwkVAAAABhYAAAAXSm9icy5EYXRlUHVibGlzaGVkIERFU0MKAen%2F%2F%2F%2Fu%2F%2F%2F%2FAQAAAAHo%2F%2F%2F%2F7f%2F%2F%2FwAAAAAAAQkUAAAAAQgAAAAGAAAACgYaAAAAD0NsaWNjYWJsZUNvbHVtbgkaAAAABhsAAAAKSm9icy5UaXRsZQoB5P%2F%2F%2F%2B7%2F%2F%2F8BAAAAAeP%2F%2F%2F%2Ft%2F%2F%2F%2FAAAAAAABCRQAAAABCQAAAAYAAAAKBh8AAAADdXJsCR8AAAAGIAAAAAolJUpPQlVSTCUlCgHf%2F%2F%2F%2F7v%2F%2F%2FwEAAAAB3v%2F%2F%2F%2B3%2F%2F%2F8AAAAAAAEJFAAAAAEKAAAABgAAAAoGJAAAABBOb1JlY29yZHNNZXNzYWdlCSQAAAAGJQAAABdOZXNzdW4gYW5udW5jaW8gdHJvdmF0bwoB2v%2F%2F%2F%2B7%2F%2F%2F8BAAAAAdn%2F%2F%2F%2Ft%2F%2F%2F%2FAAAAAAABCRQAAAABCwAAAAYAAAAKBikAAAANSGlkZGVuQ29sdW1ucwkpAAAABioAAAAKSm9icy5Kb2JJRAoB1f%2F%2F%2F%2B7%2F%2F%2F8BAAAAAdT%2F%2F%2F%2Ft%2F%2F%2F%2FAAAAAAABCRQAAAABDAAAAAYAAAAKBi4AAAALUm93c1BlclBhZ2UJLgAAAAYvAAAAAjEwCgHQ%2F%2F%2F%2F7v%2F%2F%2FwEAAAABz%2F%2F%2F%2F%2B3%2F%2F%2F8AAAAAAAEJFAAAAAENAAAABgAAAAoGMwAAABpVcGRhdGVJbXByZXNzaW9uU3RhdGlzdGljcwkzAAAABjQAAAAEdHJ1ZQoBy%2F%2F%2F%2F%2B7%2F%2F%2F8BAAAAAcr%2F%2F%2F%2Ft%2F%2F%2F%2FAAAAAAABCRQAAAABDgAAAAYAAAAKBjgAAAAJSHRtbElucHV0CTgAAAAGOQAAAK0EDQogICAgICAgIDxncmlkPg0KICAgICAgICAgICAgPGNvbHVtbnM%2BDQogICAgICAgICAgICAgICAgPGNvbHVtbiBUYWdOYW1lPSJKb2JzLkpvYklEIiBIaWRkZW5Db2x1bW49InRydWUiIC8%2BDQogICAgICAgICAgICAgICAgPGNvbHVtbiBUYWdOYW1lPSJKb2JzLlRpdGxlIiBDc3NDbGFzc0NlbGw9IkdSSURfREFUX0NFTCB0aXRsZUNlbGwiIFVSTD0iJSVKT0JVUkwlJSIgLz4NCiAgICAgICAgICAgICAgICA8Y29sdW1uIFRhZ05hbWU9IkpvYnMuRGF0ZVB1Ymxpc2hlZCIgQ3NzQ2xhc3NDZWxsPSJHUklEX0RBVF9DRUwgYXV0b1dpZHRoIiAvPg0KICAgICAgICAgICAgICAgIDxjb2x1bW4gVGFnTmFtZT0iTG9jYXRpb25zLlByZWZlcnJlZExvY2F0aW9ucyIgQ3NzQ2xhc3NDZWxsPSJHUklEX0RBVF9DRUwgYXV0b1dpZHRoIiAvPg0KICAgICAgICAgICAgICAgIDxjb2x1bW4gVGFnTmFtZT0iVmFjYW5jeS5CdXNpbmVzc1VuaXRzIiBDc3NDbGFzc0NlbGw9IkdSSURfREFUX0NFTCBhdXRvV2lkdGgiIC8%2BDQogICAgICAgICAgICA8L2NvbHVtbnM%2BDQogICAgICAgIDwvZ3JpZD4NCiAgICAKAcb%2F%2F%2F%2Fu%2F%2F%2F%2FAQAAAAHF%2F%2F%2F%2F7f%2F%2F%2FwAAAAAAAQkUAAAAAQ8AAAAGAAAACgY9AAAAElJlc291cmNlRG9jdW1lbnRJRAk9AAAACAgLFJQICgHC%2F%2F%2F%2F7v%2F%2F%2FwEAAAABwf%2F%2F%2F%2B3%2F%2F%2F8AAAAAAAEJFAAAAAsWAmYPZBYCZg9kFgRmDw8WAh8AaGRkAgEPDxYCHwBoZGQCBQ9kFgYCAQ9kFgJmD2QWAmYPFgIfAQUPUG9ydGxldEJ1dHRvbjExZAIFD2QWAmYPFgYeBXRpdGxlBSNTYWx2YSBxdWVzdGEgcmljZXJjYSBjb21lIEpvYiBBbGVydB4DYWx0BSNTYWx2YSBxdWVzdGEgcmljZXJjYSBjb21lIEpvYiBBbGVydB8MBQdzYXZlam9iZAIHD2QWAmYPFgYfDwUIRmVlZCBSU1MfEAUIRmVlZCBSU1MfDAUJcnNzYnV0dG9uZGQteEqQ7frLMYYNhIQWSmUOFAI%2FruzKas2vVRbtgcSTjw%3D%3D&__VIEWSTATEGENERATOR=E50C1FF0&__EVENTVALIDATION=%2FwEdAAkX4IPQn%2BLIfiMX%2FqaLEJzm0x9qPBGzhZuZm4zpxGdzGAbjrHqjVDjUNuMbSU4FS9tNDUFigPz7SUx62ByWgMP9hJd7exwaUXHIeYmCo9mV4KOa90Oa33zjXF5pV0qEMS3NMuweG0NlP05MMpeEWAa9ai3Vmt5PasdPcc88OHoGJo1EXtxP5Fvnh5XP3I4jjAynSB0w%2F1VWA72qDUHd4IVoQUiGGgNLD1AGiWnm29jppg%3D%3D&VMFormRicerca7CurrentViewID=FindView&VMFormRicerca7%24FindView%24FormRicerca%24FormSC1%24FormSC1HiddenNew=None&VMFormRicerca7%24FindView%24FormRicerca%24FormSC1%24Fld154002654=&VMFormRicerca7%24FindView%24FormRicerca%24FormSC1%24Fld143921021Nested1=&VMFormRicerca7%24FindView%24FormRicerca%24FormSC1%24Fld143921021=&VMFormRicerca7%24FindView%24FormRicerca%24FormSC1%24Fld143921055Nested1=&VMFormRicerca7%24FindView%24FormRicerca%24FormSC1%24Fld143921055=&VMFormRicerca7%24FindView%24FormRicerca%24SCViewFindHiddenNew=None&VM10CurrentViewID=TableView&ReportGrid143920869=&VM10%24TableView%24SCViewReport%24FormSC2%24FormSC2HiddenNew=None&VM10%24TableView%24SCViewReport%24HdnQueryString=&VM10%24TableView%24SCViewReport%24SCViewReportHiddenNew=None&companyid=143920722&VM10%24TableView%24SCViewReport%24ctl03={page}',
        )
    }
     ),
)


def crawl(web):
    
    sl = slavy.slavy()
    sl.start('http://jobs.carusihr.com/')
    sl.metaExtract = True
    sl.extract(xtr_view)

    sl.WR = [web]
    
    if len(web.split("!")) > 1:
        data2 = parse_qs(web.split("!")[1])
        data2["__VIEWSTATE"] = sl.M[0].get("viewstate")
        data2["__VIEWSTATEGENERATOR"] = sl.M[0].get("generator")
        data2["__EVENTVALIDATION"] = sl.M[0].get("validation")


    #webPersonalizada = web.split("!")[0] + "!" + urlencode(data2)
    #sl.start(webPersonalizada)

    #### En caso de hacerlo por requests en vez de slavy
    var1 = requests.post(url=web.split("!")[0], data=data2)
    ##print var1.text
    sl.WR = [u"virtual:{0}".format(var1.text).encode('utf-8')] 
    sl.step(stp)
    sl.WR = ["http://jobs.carusihr.com/{0}".format(y) for y in sl.WR]

    # Para pruebas
    #sl.printWR()
    # sl.printM()
    # sl.printstatus()
    # sl.WR = sl.WR[0:5]
    #exit(0)

    if not len(sl.WR):
        raise Exception('[WARN] Empty web region')

    sl.extract(xtr)

    if not len(sl.M):
        raise Exception('[WARN] Empty Model')

    for offer in sl.M:
        ad = dict(title='', url='', city='', province='', salary=0, company='', description='', contract='',
                  published_at='')

        ad['title'] = offer.get("title", "")
        ad['description'] = re.sub("\\\\n|\\\\r|\\\\t","", offer.get("description", ""))
        ad['url'] = offer.get("@url", "")
        ad['city'] = offer.get("city", "")
        ad['province'] =offer.get("province", "")
        ad['salary'] = offer.get("salary", '0')
        ad['company'] = offer.get("company", "")
        ad['contract'] = offer.get("contract", "")

        if not ad["title"]:
            ad["title"] = re.sub("\|.*?$", "", offer.get("title_aux", ""))

        yield ad


# saltcellar = dalek.Dalek(pages, page_ads, fetched_from, db_pt, pagination_generator, debug=False)
# saltcellar.crawl = crawl
# saltcellar.exterminate()

# new code for test auto debug script
if __name__ == "__main__":

    if len(sys.argv) == 2 and sys.argv[1] == "test":
        debug_mode = True
    elif len(sys.argv) < 2:
        debug_mode = False
    else:
        print "usage: python filename.py (test)"
        print "example for test: python <filename.py> test "
        print "example for run: python <filename.py>"
        exit(1)


    saltcellar = dalek.Dalek(pages, page_ads, fetched_from, db_it, pagination_generator, debug_mode)
    saltcellar.crawl = crawl
    saltcellar.exterminate()
